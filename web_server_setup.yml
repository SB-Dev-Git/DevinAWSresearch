---
- name: åŒ…æ‹¬çš„Webã‚µãƒ¼ãƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— - Hello Worldã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
  hosts: target_servers
  become: yes
  gather_facts: yes
  
  vars:
    app_name: hello-world-webapp
    app_user: nodejs
    app_dir: /opt/{{ app_name }}
    domain_name: "{{ ansible_default_ipv4.address }}"
    
  tasks:
    # ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°ã¨Gitã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°
      yum:
        name: "*"
        state: latest
        
    - name: Gitã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      yum:
        name: git
        state: present
        
    # Node.jsç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    - name: Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
      user:
        name: "{{ app_user }}"
        system: yes
        shell: /bin/bash
        home: "{{ app_dir }}"
        create_home: yes
        
    # Node.jsã¨npmã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹å¼ï¼‰
    - name: Node.js 16.x LTSç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      shell: |
        cd /tmp
        curl -fsSL https://nodejs.org/dist/v16.20.2/node-v16.20.2-linux-x64.tar.xz -o node-v16.20.2-linux-x64.tar.xz
        tar -xf node-v16.20.2-linux-x64.tar.xz
        cp -r node-v16.20.2-linux-x64/* /usr/local/
        ln -sf /usr/local/bin/node /usr/bin/node
        ln -sf /usr/local/bin/npm /usr/bin/npm
      become: yes
      args:
        creates: /usr/bin/node

    - name: Node.jsã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
      command: /usr/bin/node --version
      register: node_version_check

    - name: npmã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
      command: /usr/bin/npm --version
      register: npm_version_check
        
    - name: Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
      command: node --version
      register: node_version
      
    - name: Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º
      debug:
        msg: "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸNode.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³: {{ node_version.stdout }}"
        
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
        
    - name: package.jsonä½œæˆ
      template:
        src: package.json.j2
        dest: "{{ app_dir }}/package.json"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
        
    - name: app.jsä½œæˆ
      template:
        src: app.js.j2
        dest: "{{ app_dir }}/app.js"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'
        
    # npmä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: npmä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      npm:
        path: "{{ app_dir }}"
        state: present
      become_user: "{{ app_user }}"
      
    # systemdã‚µãƒ¼ãƒ“ã‚¹è¨­å®š
    - name: systemdã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
      copy:
        content: |
          [Unit]
          Description=Hello World Node.js Application
          After=network.target

          [Service]
          Type=simple
          User={{ app_user }}
          WorkingDirectory={{ app_dir }}
          ExecStart=/usr/bin/node app.js
          Restart=always
          RestartSec=10
          Environment=NODE_ENV=production

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/{{ app_name }}.service
        mode: '0644'
        
    - name: systemdãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒªãƒ­ãƒ¼ãƒ‰
      systemd:
        daemon_reload: yes
        
    - name: Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹åŒ–ãƒ»èµ·å‹•
      systemd:
        name: "{{ app_name }}"
        enabled: yes
        state: started
        
    # Nginxã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š
    - name: Amazon Linux Extrasã§Nginxã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      shell: amazon-linux-extras install nginx1 -y
      become: yes
      args:
        creates: /usr/sbin/nginx
        
    - name: Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆHTTPåˆæœŸè¨­å®šï¼‰
      copy:
        content: |
          server {
              listen 80;
              server_name {{ domain_name }} {{ ansible_default_ipv4.address }};
              
              # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
              add_header X-Frame-Options DENY always;
              add_header X-Content-Type-Options nosniff always;
              add_header X-XSS-Protection "1; mode=block" always;
              
              # Let's Encryptè¨¼æ˜æ›¸æ¤œè¨¼ç”¨
              location /.well-known/acme-challenge/ {
                  root /var/www/html;
              }
              
              # Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·
              location / {
                  proxy_pass http://127.0.0.1:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
          }
        dest: /etc/nginx/conf.d/{{ app_name }}.conf
        backup: yes
        
    # Let's Encrypt Certbotã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Amazon Linux Extrasã§EPELãƒªãƒã‚¸ãƒˆãƒªæœ‰åŠ¹åŒ–
      shell: amazon-linux-extras install epel -y
      become: yes
      args:
        creates: /etc/yum.repos.d/epel.repo
        
    - name: Certbotã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      yum:
        name: 
          - certbot
          - python2-certbot-nginx
        state: present
        
    # ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šï¼ˆAmazon Linux 2å¯¾å¿œï¼‰
    - name: firewalldã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      yum:
        name: firewalld
        state: present
      become: yes
        
    - name: firewalldã‚µãƒ¼ãƒ“ã‚¹ç¢ºèªãƒ»èµ·å‹•
      systemd:
        name: firewalld
        enabled: yes
        state: started
        
    - name: HTTPè¨±å¯ï¼ˆãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ï¼‰
      firewalld:
        service: http
        permanent: yes
        state: enabled
        immediate: yes
        
    - name: HTTPSè¨±å¯ï¼ˆãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ï¼‰
      firewalld:
        service: https
        permanent: yes
        state: enabled
        immediate: yes
        
    # /var/www/htmlãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆLet's Encryptç”¨ï¼‰
    - name: /var/www/htmlãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
      file:
        path: /var/www/html
        state: directory
        mode: '0755'
        
    - name: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆNginxè¨­å®šç„¡åŠ¹åŒ–
      file:
        path: /etc/nginx/conf.d/default.conf
        state: absent
        
    - name: Nginxè¨­å®šãƒ†ã‚¹ãƒˆ
      command: nginx -t
      register: nginx_test
      
    - name: Nginxè¨­å®šãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
      debug:
        var: nginx_test.stdout_lines
        
    - name: Nginxæœ‰åŠ¹åŒ–ãƒ»èµ·å‹•
      systemd:
        name: nginx
        enabled: yes
        state: started
        
    # Let's Encrypt SSLè¨¼æ˜æ›¸å–å¾—ï¼ˆæ³¨æ„ï¼šå®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå¿…è¦ï¼‰
    - name: SSLè¨¼æ˜æ›¸å–å¾—æº–å‚™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      debug:
        msg: |
          âš ï¸  SSLè¨¼æ˜æ›¸ã®å–å¾—ã«ã¤ã„ã¦:
          - å®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åãŒå¿…è¦ã§ã™ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯å–å¾—ã§ãã¾ã›ã‚“ï¼‰
          - DNSè¨­å®šã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã“ã®ã‚µãƒ¼ãƒã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
          - ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ‰‹å‹•å–å¾—ã—ã¦ãã ã•ã„:
          sudo certbot --nginx -d your-domain.com
          
    # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
    - name: Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
      systemd:
        name: "{{ app_name }}"
      register: app_service_status
      
    - name: Nginxã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
      systemd:
        name: nginx
      register: nginx_service_status
      
    - name: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹è¡¨ç¤º
      debug:
        msg: |
          ğŸ“Š ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹:
          - {{ app_name }}: {{ app_service_status.status.ActiveState }}
          - nginx: {{ nginx_service_status.status.ActiveState }}
          
    # æœ€çµ‚ç¢ºèªã¨ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±
    - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      debug:
        msg: |
          ğŸ‰ Hello World Node.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼
          
          ğŸ“± ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±:
          - HTTP: http://{{ ansible_default_ipv4.address }}
          - HTTPS: https://{{ ansible_default_ipv4.address }} (SSLè¨¼æ˜æ›¸è¨­å®šå¾Œ)
          
          ğŸ”§ è¨­å®šæ¸ˆã¿æ©Ÿèƒ½:
          âœ… Git ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          âœ… Node.js/npm ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  
          âœ… Hello Worldã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
          âœ… systemdã‚µãƒ¼ãƒ“ã‚¹åŒ–
          âœ… Nginx ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¨­å®š
          âœ… ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š (HTTP/HTTPSè¨±å¯)
          âš ï¸  Let's Encrypt SSLè¨¼æ˜æ›¸ (æ‰‹å‹•è¨­å®šãŒå¿…è¦)
          
          ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
          1. å®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å–å¾—
          2. DNSè¨­å®šã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã‚µãƒ¼ãƒIPã«å‘ã‘ã‚‹  
          3. certbot --nginx -d your-domain.com ã§SSLè¨¼æ˜æ›¸å–å¾—
          4. Nginxè¨­å®šã‚’æœ¬ç•ªç”¨ã«æ›´æ–°
